# II - Serveur DNS ma√Ætre faisant autorit√©


![](../../../media/logo-cub.png)

## Pr√©requis

![](../../../media/schema-logique-cub.png)

*Ducumentation en ligne : [https://cubdocumentation.sioplc.fr](https://cubdocumentation.sioplc.fr)*
<br>

## Adressage 

| Puissance de 2 | Valeur |
|:---------------:|:------:|
| 2‚Å∞ | 1 |
| 2¬π | 2 |
| 2¬≤ | 4 |
| 2¬≥ | 8 |
| 2‚Å¥ | 16 |
| 2‚Åµ | 32 |
| 2‚Å∂ | 64 |
| <span style="background-color:#aee7ff; padding:2px 4px; border-radius:3px;">**2‚Å∑**</span> | <span style="background-color:#aee7ff; padding:2px 4px; border-radius:3px;">**128**</span> |

**Adresse r√©seau : 192.168.6.0/24**

<br>

| **Service** | **Nombre d‚Äôh√¥tes** | **Adresse r√©seau** | **Masque de sous-r√©seau** | **Adresse de diffusion** | **Description VLAN** |
|--------------|--------------------:|--------------------|----------------------------|---------------------------|----------------------|
| Production | 120 | 192.168.6.0 | <span style="background-color:#b7fbb7;">255.255.255.128</span> | 192.168.6.127 | VLAN 56 |
| Client 1 | 32 | 192.168.6.128 | 255.255.255.192 | 192.168.6.191 | VLAN 10 |
| Administration syst√®mes et r√©seaux | 6 | 192.168.6.192 | 255.255.255.240 | 192.168.6.207 | VLAN 20 |

<br>

**N¬∞1 sous-r√©seau Production = 126 h√¥tes ‚Üí** <span style="background-color:#aee7ff; padding:2px 4px; border-radius:3px;">**2‚Å∑**</span> **‚Üí <span style="background-color:#b7fbb7;">/25**</span>

**Production = 192.168.6.0/24 ‚Üí 255.255.255.128 ‚Üí** <span style="background-color:#aee7ff; padding:2px 4px; border-radius:3px;">**x.x.x.1000 0000**</span>

**Diffusion :** `1100 0000 . 1010 1000 . 0000 0110 . 0111 1111`  
‚û°Ô∏è 192.168.6.**127**

___

## Sch√©ma logique ‚Äì Agence Frankfur

![](../../../media/bloc2/ExploitationServ/Activite0-1.png)

___
## Packet tracert - Agence Frankfurt
<br>

![](../../../media/packet-tracert-v1.jpg)
<br>

<div style="text-align:center; margin-top:20px;">
  <a href="https://drive.google.com/file/d/1L7Gp52YpPjjRhFdp9gp4L1sGORqAoCEK/view?usp=share_link" 
     style="display:inline-block;
            background:#e7e7e9;
            color:#0096FF;
            padding:11px 25px;
            border-radius:10px;
            text-decoration:none;
            font-weight:50;
            box-shadow:0 0 12px rgba(0,0,0,0.5);
            transition:all 0.3s ease;"
     onmouseover="this.style.background='#dcdce0'; this.style.color='#003d80';"
     onmouseout="this.style.background='#e7e7e9'; this.style.color='#0096FF';">
     üîó Cliquer pour t√©l√©cherger le paket tracert
  </a>
</div>
<br>

___

## Plan de c√¢blage 

![](../../../media/bloc2/ExploitationServ/Activite0-2.png)

___

!!! note "Information sur le contexte"
    DNS faisant autorit√© ‚Üí DMZ 
    @IP de mon DNS ‚Üí 192.36.6.10
    @IP du DNS de mon camarade ‚Üí 192.36.6.11
    
    Nom de domaine FQDN : ns0.frankfurt.cub.sioplc.fr

## 1.  V√©rification pr√©alable

Mettez √† jour votre serveur

```bash
sudo apt update && sudo apt upgrade
```

Sur votre serveur Debian 12, installez le service de journalisation rsyslog √† la place de journalctl. Cela vous permettra de disposer de fichiers de log clairs au format texte situ√©s dans `/var/log`.

```bash
sudo apt install rsyslog
```

Installez le service Bind 9 et les outils diagnostics DNS

```bash
sudo apt install bind9 dnsutils
```

## 2. D√©finir les param√®tres r√©seaux du serveur

```bash
sudoedit /etc/network/interfaces
```

## 3. D√©finir le serveur DNS r√©cursif √† utiliser

```bash
sudoedit /etc/resolv.conf
```
![](../../../media/bloc2/ExploitationServ/Activite1-9.png)


??? info "Pourquoi choisir ces serveurs DNS r√©cursifs ?"
    Pour rappel, les serveurs DNS faisant autorit√© g√®rent, dans la majorit√© des cas, des zones publiques appartenant √† l'arborescence r√©elle. Ainsi, ils seront la plupart du temps h√©berg√©s dans une DMZ contrairement aux serveurs DNS r√©cursifs qui seront install√©s dans le LAN. Pour des raisons √©videntes de s√©curit√©, il est plus pertinent que les serveurs d√©finis dans le fichier `/etc/resolv.conf` soient des r√©solveurs publics plut√¥t que les r√©solveurs internes param√©tr√©s pr√©c√©demment. 

## 4. Prendre en compte les modifications des param√®tres r√©seaux

```bash
sudo systemctl restart networking
```

##¬†5. Configurer correctement les fichiers `/etc/hostname et /etc/hosts`

Le fichier **hostname** sert √† donner un nom √† votre serveur.

```bash
sudoedit /etc/hostname
```

```bash
ns0
```
!!! Info  "Information"
    Le fichier hosts, anc√™tre des stubresolver DNS, permet de faire la correspondance entre un nom et une IP. Il est g√©n√©ralement prioritaire sur la r√©solution DNS (pour modifier l‚Äôordre de pr√©f√©rence, √©ditez le fichier `/etc/nsswitch.conf`). Dans ce fichier, il est important de renseigner la correspondance entre votre adresse de boucle locale et un nom. Ainsi, si votre machine sollicite le nom indiqu√© lors d'un processus particulier, cela la renverra vers l'adresse de loopback.

```bash
sudoedit /etc/hosts
```
![](../../../media/bloc2/ExploitationServ/Activite1-10.png)

Il est n√©cessaire de red√©marrer le serveur pour prendre en compte le changement de nom.

```bash
sudo shutdown -r now
```

## 6. Principes g√©n√©raux concernant Bind9 et le service DNS.

1. Cr√©er dans le r√©pertoire `/var/named/` les zones ad√©quates √† l‚Äôaide d‚Äôun fichier db.xxxxxx (ou xxxxxx correspond √† votre nom de domaine) par exemple, db.tours.btsssio.fr.
2. Initialiser la ou les zones dans `/etc/bind/named.conf.local`
3. Ajouter ou g√©rer les options globales du daemon Bind 9 dans `/etc/bind/named.conf.options`
4. Faire particuli√®rement attention √† la syntaxe. 
5. Penser aux commandes de test et red√©marrer ou recharger le service.

Les commandes √† conna√Ætre absolument sont les suivantes et vous seront utiles tout au long de votre activit√©¬†:

* dig
* host
* nslookup (sous Windows)
* named-checkconf
* named-checkzone
* service bind9 stop|start|restart|reload|status (fonctionne avec SysVinit, systemd)
* avec systemd, systemctl stop|start|restart|reload|status bind9

## 7. Exemple de configuration d'un serveur DNS ma√Ætre faisant autorit√©

!!! Warning  "Attention"
    Il est recommand√© de supprimer le contenu des fichiers de configuration par d√©faut et d'utiliser le contenu fourni ci-dessous. N'oubliez pas que **etckeeper** doit √™tre mobilis√©.

```bash
sudo cat /etc/bind/named.conf
``` 

![](../../../media/bloc2/ExploitationServ/Activite1-11.png)


Le fichier `/etc/bind/named.conf` est le fichier de configuration global du service DNS. Il est possible d'y renseigner tous les param√®tres de configuration du service.

Sous Debian, il a √©t√© d√©cid√© dans un souci de lisibilit√©, de scinder la configuration en plusieurs fichiers. Ces fichiers sont appel√©s par le fichier de configuration g√©n√©ral √† l'aide de la directive include.

* Le fichier named.conf.options est utilis√© pour d√©clarer les options de configuration li√©es √† Bind.
* Le fichier named.conf.local sert √† d√©clarer les zones nouvellement cr√©√©es.
* Le fichier named.conf.default-zones contient les d√©clarations de fichier de zone concernant la racine DNS et la boucle locale.
* Le fichier named.conf.log n'existe pas mais vous permettra de g√©rer la journalisation de votre service dans un fichier texte d√©di√©.

```bash
sudo cat /etc/bind/named.conf.options
```

![](../../../media/bloc2/ExploitationServ/Activite1-12.png)


```bash
sudoedit /etc/bind/named.conf.local
```

![](../../../media/bloc2/ExploitationServ/Activite1-13.png)


Ce fichier sert √† d√©clarer les zones que vous aurez √† g√©rer. Votre serveur peut-√™tre ma√Ætre sur une zone ou esclave. La directive file sert √† d√©clarer le fichier de zone contenant les enregistrements li√©s (SOA, NS, A‚Ä¶). La directive allow-transfer permet de d√©clarer les serveurs esclaves habilit√©s.

!!! Warning  "Attention"
	Le num√©ro de s√©rie ne doit jamais √™tre choisi au hasard et **syst√©matiquement incr√©ment√© √† chaque modification du fichier de zone**. Les guides de bonnes pratiques recommande de choisir la date du jour sous **2025090101** (ann√©e/mois/jour/id). Dans le cas d'une architecture ma√Ætre-esclave si le num√©ro de s√©rie pr√©sent sur le ma√Ætre se retrouve **d√©cr√©ment√©** et inf√©rieur √† celui du serveur esclave, **le transfert de zone ne se fera plus !**

```bash
sudoedit /var/cache/bind/db.frankfurt.cub.sioplc.fr
sudo chown bind:bind /var/cache/bind/db.frankfurt.cub.sioplc.fr
```
![](../../../media/bloc2/ExploitationServ/Activite1-14.png)


!!! Warning  "Attention"
    Ceci est un exemple de fichier de zone √† r√©adapter sans les commentaires (;). Tous les enregistrements pr√©sents dans cet exemple ne servent pas forc√©ment dans le TP. Par contre, il est pertinent de rechercher leurs significations sur Internet pour comprendre √† quoi ils peuvent servir dans un contexte professionnel.

Mise en place d‚Äôune journalisation des √©v√®nements du service DNS

```bash
sudoedit /etc/bind/named.conf.log
```
![](../../../media/bloc2/ExploitationServ/Activite1-15.png)

Ce fichier permet d'activer la journalisation des √©v√®nements pour le service DNS. Vous pouvez pr√©ciser le niveau de verbosit√© avec la directive severity mais aussi la taille maximale du fichier de log. Comme pour le fichier de zone esclave, il est n√©cessaire de cr√©er un fichier vide de log avec les bonnes permissions au pr√©alable :

```bash
sudo touch /var/log/bind.log
sudo chown bind:bind /var/log/bind.log
```

Enfin, on n‚Äôoublie pas de d√©clarer ce nouveau fichier de configuration dans `/etc/bind/named.conf`.

```bash
sudoedit /etc/bind/named.conf
```

![](../../../media/bloc2/ExploitationServ/Activite1-16.png)


!!! Warning  "Attention"
    Sur les syst√®mes Debian r√©cents, un logiciel de s√©curit√© de type MAC (Mandatory Access Control) nomm√© AppArmor est activ√© par d√©faut. Il surveille entre autres les droits d‚Äôacc√®s des diff√©rents processus lanc√©s sur le syst√®me. Par d√©faut, AppArmor emp√™che le service Bind 9 de lire et √©crire dans le r√©pertoire `/var/log/`. Il est donc indispensable de changer ces permissions.

```bash
sudoedit /etc/apparmor.d/usr.sbin.named
```

```bash
# On autorise le daemon Bind 9 √† lire et ecrire dans le fichier /var/log/bind.log

/var/log/bind.log rw,
```
![](../../../media/bloc2/ExploitationServ/Activite1-17.png)


On v√©rifie que le nouveau fichier de configuration de AppArmor ne contient pas d‚Äôerreurs puis on red√©marre le service.

```bash
sudo apparmor_parser -r /etc/apparmor.d/usr.sbin.named
sudo systemctl restart apparmor
```

??? info "named-checkconf"
    La commande named-checkconf permet de v√©rifier si des erreurs de syntaxe sont pr√©sentes et de fournir les √©l√©ments ou lignes qui posent probl√®me dans un fichier en particulier.

```bash
sudo named-checkconf -z
sudo systemctl restart bind9
sudo systemctl status bind9
```